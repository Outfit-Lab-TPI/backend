services:
  # ===== Backend Application =====
  outfitlab-backend:
    build: 
      context: .
      dockerfile: Dockerfile.multistage
    ports:
      - "${SERVER_PORT:-8080}:8080"
    environment:
      # Profile para configuraci√≥n cloud
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-cloud}
      
      # Database connection (PostgreSQL Cloud - Render)
      - SPRING_DATASOURCE_RENDER_URL=${SPRING_DATASOURCE_RENDER_URL}
      - SPRING_DATASOURCE_RENDER_USERNAME=${SPRING_DATASOURCE_RENDER_USERNAME}
      - SPRING_DATASOURCE_RENDER_PASSWORD=${SPRING_DATASOURCE_RENDER_PASSWORD}
      
      # Security
      - SPRING_SECURITY_USER=${SPRING_SECURITY_USER}
      - SPRING_SECURITY_PASSWORD=${SPRING_SECURITY_PASSWORD}
      
      # AWS S3 Configuration
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
      - AWS_BUCKET_NAME=${AWS_BUCKET_NAME}
      
      # JVM and Logging
      - JAVA_OPTS=${JAVA_OPTS}
      - LOG_LEVEL_ROOT=${LOG_LEVEL_ROOT}
      - LOG_LEVEL_OUTFITLAB=${LOG_LEVEL_OUTFITLAB}
      
      # File upload limits
      - MAX_FILE_SIZE=${MAX_FILE_SIZE}
      - MAX_REQUEST_SIZE=${MAX_REQUEST_SIZE}
      
      # API Keys
      - FASHION_IA_SECRET_KEY=${FASHION_IA_SECRET_KEY}
      - MP_ACCESS_TOKEN=${MP_ACCESS_TOKEN}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      
      # Backend API URL (for email links)
      - BACKEND_API_URL=${BACKEND_API_URL:-http://localhost:8080}
      
      # Webhook URL for Mercado Pago
      - WEBHOOK_BASE_URL=${WEBHOOK_BASE_URL:-http://localhost:8080}
      
      # JWT Authentication
      - JWT_SECRET=${JWT_SECRET:-mySecretKeyForJWT123456789012345678901234567890}
      - TOKEN_EXPIRATION=${TOKEN_EXPIRATION:-86400000}
      - REFRESH_EXPIRATION=${REFRESH_EXPIRATION:-604800000}
      
      # Frontend Configuration
      - FRONTEND_BASE_URL=${FRONTEND_BASE_URL:-http://localhost:5173}
      - FRONTEND_ORIGINS=${FRONTEND_ORIGINS:-http://localhost:5173,https://*.vercel.app}
      
      # Gmail/Email Configuration
      - SPRING_MAIL_USERNAME=${SPRING_MAIL_USERNAME:-tpi8bits@gmail.com}
      - SPRING_MAIL_PASSWORD=${SPRING_MAIL_PASSWORD}
    
    restart: unless-stopped
    networks:
      - outfitlab-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ===== Networks =====
networks:
  outfitlab-network:
    driver: bridge