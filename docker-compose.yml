services:
  # ===== Backend Application =====
  outfitlab-backend:
    build: 
      context: .
      dockerfile: Dockerfile.multistage
    ports:
      - "${SERVER_PORT:-8080}:8080"
    environment:
      # Profile para configuraci√≥n cloud
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-cloud}
      
      # Database connection (PostgreSQL Cloud - Render)
      - SPRING_DATASOURCE_RENDER_URL=${SPRING_DATASOURCE_RENDER_URL}
      - SPRING_DATASOURCE_RENDER_USERNAME=${SPRING_DATASOURCE_RENDER_USERNAME}
      - SPRING_DATASOURCE_RENDER_PASSWORD=${SPRING_DATASOURCE_RENDER_PASSWORD}
      
      # Security
      - SPRING_SECURITY_USER=${SPRING_SECURITY_USER}
      - SPRING_SECURITY_PASSWORD=${SPRING_SECURITY_PASSWORD}
      
      # AWS S3 Configuration
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
      - AWS_BUCKET_NAME=${AWS_BUCKET_NAME}
      
      # JVM and Logging
      - JAVA_OPTS=${JAVA_OPTS}
      - LOG_LEVEL_ROOT=${LOG_LEVEL_ROOT}
      - LOG_LEVEL_OUTFITLAB=${LOG_LEVEL_OUTFITLAB}
      
      # File upload limits
      - MAX_FILE_SIZE=${MAX_FILE_SIZE}
      - MAX_REQUEST_SIZE=${MAX_REQUEST_SIZE}
      
      # API Keys
      - FASHION_IA_SECRET_KEY=${FASHION_IA_SECRET_KEY}
    
    restart: unless-stopped
    networks:
      - outfitlab-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ===== Networks =====
networks:
  outfitlab-network:
    driver: bridge